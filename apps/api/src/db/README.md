# Database Setup

This directory contains database configuration using Drizzle ORM for the Ubiquitous Language System.

## Structure

- `connection.ts` - Drizzle database connection
- `config.ts` - Database configuration and validation
- `migrate.ts` - Drizzle migration runner
- `schema/` - Drizzle schema definitions
  - `bounded-contexts.ts` - Bounded contexts table
  - `terms.ts` - Terms table
  - `term-history.ts` - Term history table
  - `term-relationships.ts` - Term relationships table
  - `term-proposals.ts` - Term proposals table
  - `discussions.ts` - Discussion threads and comments tables
  - `reviews.ts` - Reviews table
  - `user-learning.ts` - User learning tracking table
  - `analysis.ts` - AI and code analysis tables
  - `user-activity.ts` - User activity logs table
- `migrations/` - Generated SQL migration files (auto-generated by Drizzle Kit)

## Setup

### 1. Configure Database

Create a `.env` file in `apps/api/` with your database configuration:

```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/ubiquitous_language
```

Or use individual variables:

```env
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ubiquitous_language
DB_USER=postgres
DB_PASSWORD=postgres
```

### 2. Create Database

```bash
# Using psql
createdb ubiquitous_language

# Or using SQL
psql -U postgres -c "CREATE DATABASE ubiquitous_language;"
```

### 3. Generate and Run Migrations

Drizzle ORM automatically generates migrations from your schema:

```bash
cd apps/api

# Generate migration files from schema
npm run db:generate

# Apply migrations to database
npm run db:migrate

# Or push schema directly (for development)
npm run db:push
```

## Database Schema

The initial schema includes the following tables:

### Core Tables
- `bounded_contexts` - Bounded contexts for organizing terms
- `terms` - Domain terms with definitions
- `term_history` - Version history of term changes
- `term_relationships` - Relationships between terms

### Collaboration Tables
- `term_proposals` - Proposed terms awaiting approval
- `discussion_threads` - Discussion threads for terms/proposals
- `comments` - Comments on discussion threads
- `reviews` - Review records for terms

### Learning & Analytics
- `user_learning` - Tracks which terms users have learned
- `user_activity` - User activity logs for analytics
- `code_analysis` - Code analysis results
- `ai_analysis` - AI analysis results

### Indexes

The schema includes optimized indexes for:
- Fast term lookups by name and context
- Efficient status filtering
- Review date queries
- History tracking
- Relationship traversal

### Constraints

- Unique term names within each bounded context
- Referential integrity with CASCADE deletes
- Check constraints for valid enum values
- No self-referencing relationships

## Drizzle ORM Features

### Type-Safe Queries

Drizzle provides full TypeScript type safety:

```typescript
import { db } from './db';
import { terms, boundedContexts } from './db/schema';
import { eq } from 'drizzle-orm';

// Select with type inference
const allTerms = await db.select().from(terms);

// Filter with type-safe conditions
const activeTerms = await db
  .select()
  .from(terms)
  .where(eq(terms.status, 'active'));

// Join tables
const termsWithContext = await db
  .select()
  .from(terms)
  .leftJoin(boundedContexts, eq(terms.boundedContextId, boundedContexts.id));
```

### Connection Configuration

The connection is configured with:
- Max 20 connections
- 30s idle timeout
- 2s connection timeout
- Automatic error handling

### Migration System

Drizzle Kit automatically generates migrations:

1. **Modify schema** - Update files in `src/db/schema/`
2. **Generate migration** - Run `npm run db:generate`
3. **Review SQL** - Check generated files in `src/db/migrations/`
4. **Apply migration** - Run `npm run db:migrate`

### Drizzle Studio

Explore your database with Drizzle Studio:

```bash
npm run db:studio
```

This opens a web interface at `https://local.drizzle.studio`
